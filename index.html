<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PINMAP - Mapa Interativo com Busca</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        
        #mapa {
            height: 100vh; /* Garante que o mapa ocupe 100% da altura da viewport */
            width: 100%; /* Garante que o mapa ocupe 100% da largura da viewport */
        }
        
        /* Sistema de Busca */
        .sistema-busca-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 320px;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .busca-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .busca-input-container {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .busca-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            outline: none;
        }
        
        .busca-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        .busca-btn {
            padding: 12px 16px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 80px;
        }
        
        .busca-btn:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-1px);
        }
        
        .busca-btn:active {
            transform: translateY(0);
        }
        
        .busca-loading {
            display: none;
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 14px;
        }
        
        .busca-resultados {
            display: none;
            max-height: 250px;
            overflow-y: auto;
            border-top: 1px solid #eee;
            margin-top: 10px;
        }
        
        .resultado-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        
        .resultado-item:hover {
            background: #f8f9fa;
            transform: translateX(2px);
        }
        
        .resultado-item:last-child {
            border-bottom: none;
        }
        
        .resultado-nome {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .resultado-endereco {
            color: #666;
            font-size: 12px;
            line-height: 1.3;
        }
        
        .resultado-tipo {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-top: 4px;
        }
        
        /* Controles do mapa */
        .controles-mapa {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .botao-controle {
            background: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            min-width: 120px;
            font-weight: 500;
        }
        
        .botao-controle:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* Info overlay */
        .info-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-width: 300px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .info-overlay h4 {
            margin: 0 0 12px 0;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .info-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 12px;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .stat-item:hover {
            background: #e9ecef;
        }
        
        .stat-number {
            font-weight: bold;
            font-size: 18px;
            color: #007bff;
            margin-bottom: 2px;
        }
        
        .stat-label {
            color: #666;
            font-size: 11px;
        }
        
        /* Responsivo */
        @media (max-width: 768px) {
            .sistema-busca-container {
                top: 10px;
                left: 10px;
                right: 10px;
                min-width: auto;
                max-width: none;
            }
            
            .controles-mapa {
                top: 10px;
                right: 10px;
            }
            
            .info-overlay {
                bottom: 10px;
                left: 10px;
                right: 10px;
                max-width: none;
            }
            
            .info-stats {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* Loading animation */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="mapa"></div>
    
    <div class="sistema-busca-container">
        <div class="busca-header">
            üîç Buscar Localiza√ß√£o
        </div>
        <div class="busca-input-container">
            <input type="text" 
                   id="busca-geral-input" 
                   class="busca-input"
                   placeholder="Digite nome, rua, cidade, CEP..."
                   autocomplete="off">
            <button id="busca-geral-btn" class="busca-btn">Buscar</button>
        </div>
        <div id="busca-loading" class="busca-loading">
            <span class="loading-spinner"></span> Buscando...
        </div>
        <div id="busca-resultados" class="busca-resultados"></div>
    </div>
    
    <div class="controles-mapa">
        <button class="botao-controle" onclick="voltarInicio()" title="Voltar ao in√≠cio">
            üè† In√≠cio
        </button>
        <button class="botao-controle" onclick="centralizarUsuarios()" title="Ver todos os usu√°rios">
            üë• Usu√°rios
        </button>
        <button class="botao-controle" onclick="alternarClustering()" title="Alternar clustering">
            üîó Cluster
        </button>
        <button class="botao-controle" onclick="limparBusca()" title="Limpar busca">
            üßπ Limpar
        </button>
        <button class="botao-controle" onclick="alternarLayoutMapa()" title="Alternar entre estilos de mapa">
            üé® Layout
        </button>
        <button class="botao-controle" onclick="obterMinhaLocalizacao()" title="Encontrar minha localiza√ß√£o">
            üìç Minha Localiza√ß√£o
        </button>
    </div>
    
    <div class="info-overlay">
        <h4>üìä Estat√≠sticas do Mapa</h4>
        <div class="info-stats">
            <div class="stat-item">
                <div class="stat-number" id="total-usuarios-mapa">0</div>
                <div class="stat-label">Usu√°rios</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="buscas-realizadas-mapa">0</div>
                <div class="stat-label">Buscas</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="zoom-atual">4</div>
                <div class="stat-label">Zoom</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="marcadores-visiveis">0</div>
                <div class="stat-label">Vis√≠veis</div>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="dados.js"></script>
    
    <script>
        // Vari√°veis globais
        let mapa;
        let marcadores; // Grupo de marcadores com clustering
        let todosMarcadoresUsuario = []; // Array para gerenciar marcadores de usu√°rios individualmente
        let marcadoresBuscaPoi = L.featureGroup(); // Grupo para marcadores de busca de POI (endere√ßo/com√©rcio)
        let userLocationMarker = null; // Marcador para a localiza√ß√£o do usu√°rio
        let clusteringAtivo = true;
        let contadorBuscas = 0;
        let cacheResultados = new Map();
        let currentTileLayer; // Para gerenciar a camada de mapa ativa

        // NOVO: Camadas de mapa
        const camadasMapa = {
            'light': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CartoDB | PINMAP v5.4',
                noWrap: true
            }),
            'dark': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CartoDB | PINMAP v5.4',
                noWrap: true
            }),
            'satellite': L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
                maxZoom: 20,
                subdomains:['mt0','mt1','mt2','mt3'],
                attribution: '¬© Google Satellite | PINMAP v5.4',
                noWrap: true
            }),
            'terrain': L.tileLayer('https://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
                maxZoom: 20,
                subdomains:['mt0','mt1','mt2','mt3'],
                attribution: '¬© Google Terrain | PINMAP v5.4',
                noWrap: true
            })
        };

        // Elementos do DOM
        const buscaInput = document.getElementById('busca-geral-input');
        const buscaBtn = document.getElementById('busca-geral-btn');
        const buscaLoading = document.getElementById('busca-loading');
        const buscaResultadosDiv = document.getElementById('busca-resultados');

        // URLs da API de geocodifica√ß√£o
        const nominatimApiUrl = 'https://nominatim.openstreetmap.org/search?format=json&limit=10&q=';

        // --- Fun√ß√µes de Inicializa√ß√£o e L√≥gica do Mapa ---

        function iniciarMapa() {
            // Campinas, SP como centro inicial
            mapa = L.map('mapa', {
                center: [-22.9099, -47.0626], 
                zoom: 12,
                zoomControl: false // Desabilita o controle de zoom padr√£o do Leaflet
            });

            // Adiciona um controle de zoom personalizado (opcional, para um visual mais limpo)
            L.control.zoom({ position: 'topright' }).addTo(mapa);


            // Define a camada inicial
            currentTileLayer = camadasMapa.light;
            currentTileLayer.addTo(mapa);

            // Inicializa o grupo de marcadores (clustering)
            marcadores = L.markerClusterGroup();
            mapa.addLayer(marcadores);

            // Adiciona o grupo de marcadores de busca de POI
            mapa.addLayer(marcadoresBuscaPoi);

            carregarMarcadoresUsuario();
            atualizarEstatisticas();

            // Eventos do mapa para atualizar estat√≠sticas
            mapa.on('zoomend moveend', atualizarEstatisticas);
            
            // Evento para atualizar o n√∫mero de marcadores vis√≠veis no cluster
            if (clusteringAtivo) {
                 marcadores.on('clusterclick', function (a) {
                    a.layer.zoomToBounds();
                });
                marcadores.on('add remove', atualizarEstatisticas); // Atualiza quando marcadores s√£o adicionados/removidos do cluster
            }
        }

        function carregarMarcadoresUsuario() {
            if (typeof usuarios !== 'undefined' && Array.isArray(usuarios)) {
                todosMarcadoresUsuario = []; // Limpa array antes de recarregar

                usuarios.forEach(usuario => {
                    if (usuario.lat && usuario.lon) {
                        const marcador = L.marker([usuario.lat, usuario.lon]);
                        marcador.bindPopup(`
                            <strong>${usuario.nome}</strong><br>
                            ${usuario.endereco || 'Endere√ßo n√£o informado'}<br>
                            Tipo: <span class="resultado-tipo">${usuario.tipo || 'Geral'}</span>
                        `);
                        todosMarcadoresUsuario.push(marcador);
                    }
                });

                // Adiciona marcadores ao grupo de cluster ou diretamente ao mapa
                if (clusteringAtivo) {
                    marcadores.addLayers(todosMarcadoresUsuario);
                } else {
                    todosMarcadoresUsuario.forEach(m => m.addTo(mapa));
                }
                document.getElementById('total-usuarios-mapa').textContent = usuarios.length;
            } else {
                console.warn("Array 'usuarios' n√£o encontrado ou n√£o √© um array v√°lido em dados.js");
            }
        }

        function atualizarEstatisticas() {
            document.getElementById('zoom-atual').textContent = mapa.getZoom();
            
            // Contagem de marcadores vis√≠veis:
            let visiveis = 0;
            if (clusteringAtivo) {
                // Leaflet.markercluster n√£o tem um m√©todo direto para 'marcadores vis√≠veis no viewport'.
                // Isso pode ser complexo. Para simplificar, vou contar todos os marcadores de usu√°rio
                // e os marcadores de busca se estiverem no mapa.
                // Uma implementa√ß√£o mais robusta envolveria verificar se cada marcador est√° dentro dos limites do mapa.
                // Por agora, vamos assumir que marcadores de usu√°rio s√£o sempre contados (ou a contagem do cluster)
                // e os de busca se est√£o no mapa.
                visiveis = marcadores.getLayers().length; // Retorna o n√∫mero de marcadores no cluster
            } else {
                // Se o clustering estiver desativado, contamos os marcadores de usu√°rio e de busca
                // que realmente est√£o na tela. (Esta parte √© uma simplifica√ß√£o, idealmente
                // voc√™ iteraria sobre `todosMarcadoresUsuario` e `marcadoresBuscaPoi.getLayers()`
                // e usaria `mapa.getBounds().contains(marcador.getLatLng())` para precis√£o.)
                visiveis = todosMarcadoresUsuario.length + marcadoresBuscaPoi.getLayers().length;
            }
            document.getElementById('marcadores-visiveis').textContent = visiveis; // Ajuste conforme a complexidade desejada
        }

        // --- Fun√ß√µes de Controle do Mapa ---

        function voltarInicio() {
            mapa.setView([-22.9099, -47.0626], 12); // Centro e zoom iniciais
            limparBusca(); // Limpa resultados de busca ao voltar ao in√≠cio
            if (!clusteringAtivo && todosMarcadoresUsuario.length > 0) {
                todosMarcadoresUsuario.forEach(m => m.addTo(mapa)); // Garante que os marcadores de usu√°rio apare√ßam
            }
            atualizarEstatisticas();
        }

        function centralizarUsuarios() {
            if (todosMarcadoresUsuario.length > 0) {
                const group = new L.featureGroup(todosMarcadoresUsuario);
                mapa.fitBounds(group.getBounds());
            } else {
                alert('Nenhum usu√°rio para centralizar.');
            }
            limparBusca(); // Limpa resultados de busca ao centralizar usu√°rios
            atualizarEstatisticas();
        }

        function alternarClustering() {
            clusteringAtivo = !clusteringAtivo;
            if (clusteringAtivo) {
                // Remove todos os marcadores de usu√°rio do mapa e adiciona ao cluster
                todosMarcadoresUsuario.forEach(m => mapa.removeLayer(m));
                marcadores.addLayers(todosMarcadoresUsuario);
                mapa.addLayer(marcadores);
                console.log("Clustering Ativado");
            } else {
                // Remove o cluster e adiciona todos os marcadores de usu√°rio diretamente ao mapa
                mapa.removeLayer(marcadores);
                todosMarcadoresUsuario.forEach(m => m.addTo(mapa));
                console.log("Clustering Desativado");
            }
            // Limpa e recarrega os marcadores de busca se houver
            marcadoresBuscaPoi.clearLayers();
            buscaResultadosDiv.style.display = 'none';
            atualizarEstatisticas();
            alert(`Agrupamento de marcadores: ${clusteringAtivo ? 'Ativado' : 'Desativado'}`);
        }

        function limparBusca() {
            buscaInput.value = '';
            buscaResultadosDiv.innerHTML = '';
            buscaResultadosDiv.style.display = 'none';
            marcadoresBuscaPoi.clearLayers(); // Remove marcadores de busca do mapa
            if (userLocationMarker) { // Remove o marcador de localiza√ß√£o do usu√°rio
                mapa.removeLayer(userLocationMarker);
                userLocationMarker = null;
            }
            atualizarEstatisticas();
            // Re-adiciona os marcadores de usu√°rio se eles foram removidos para uma busca espec√≠fica
            if (!clusteringAtivo && todosMarcadoresUsuario.length > 0) {
                todosMarcadoresUsuario.forEach(m => m.addTo(mapa));
            }
        }

        let layoutAtualIndex = 0;
        const layoutsDisponiveis = ['light', 'dark', 'satellite', 'terrain'];

        function alternarLayoutMapa() {
            mapa.removeLayer(currentTileLayer); // Remove a camada atual
            layoutAtualIndex = (layoutAtualIndex + 1) % layoutsDisponiveis.length;
            const proximoLayout = layoutsDisponiveis[layoutAtualIndex];
            currentTileLayer = camadasMapa[proximoLayout];
            currentTileLayer.addTo(mapa); // Adiciona a nova camada
            alert(`Layout do Mapa: ${proximoLayout.charAt(0).toUpperCase() + proximoLayout.slice(1)}`);
        }

        function obterMinhaLocalizacao() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const userLatLng = L.latLng(lat, lon);

                        // Remove marcador anterior, se houver
                        if (userLocationMarker) {
                            mapa.removeLayer(userLocationMarker);
                        }

                        // Adiciona novo marcador para a localiza√ß√£o do usu√°rio
                        userLocationMarker = L.marker(userLatLng).addTo(mapa)
                            .bindPopup("Voc√™ est√° aqui!").openPopup();

                        mapa.setView(userLatLng, 15); // Centraliza e d√° zoom na localiza√ß√£o do usu√°rio
                        alert('Sua localiza√ß√£o foi encontrada!');
                        atualizarEstatisticas();
                    },
                    (error) => {
                        console.error("Erro ao obter localiza√ß√£o:", error);
                        alert("N√£o foi poss√≠vel obter sua localiza√ß√£o. Por favor, verifique as permiss√µes do navegador.");
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                alert("Geolocaliza√ß√£o n√£o √© suportada por este navegador.");
            }
        }

        // --- Fun√ß√µes de Busca ---

        async function realizarBuscaGeral() {
            const query = buscaInput.value.trim();
            if (query === '') {
                buscaResultadosDiv.innerHTML = '';
                buscaResultadosDiv.style.display = 'none';
                marcadoresBuscaPoi.clearLayers(); // Limpa marcadores de busca se a busca for vazia
                return;
            }

            buscaLoading.style.display = 'block';
            buscaResultadosDiv.style.display = 'none';
            buscaResultadosDiv.innerHTML = ''; // Limpa resultados anteriores
            marcadoresBuscaPoi.clearLayers(); // Limpa marcadores de busca anteriores
            contadorBuscas++;
            document.getElementById('buscas-realizadas-mapa').textContent = contadorBuscas;

            if (cacheResultados.has(query)) {
                exibirResultadosBusca(cacheResultados.get(query));
                buscaLoading.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${nominatimApiUrl}${encodeURIComponent(query)}`);
                const data = await response.json();

                cacheResultados.set(query, data); // Armazena em cache
                exibirResultadosBusca(data);

            } catch (error) {
                console.error('Erro na busca:', error);
                buscaResultadosDiv.style.display = 'block';
                buscaResultadosDiv.innerHTML = '<div style="padding: 10px; color: red;">Erro ao buscar localiza√ß√£o. Tente novamente.</div>';
            } finally {
                buscaLoading.style.display = 'none';
            }
        }

        function exibirResultadosBusca(resultados) {
            if (resultados.length === 0) {
                buscaResultadosDiv.style.display = 'block';
                buscaResultadosDiv.innerHTML = '<div style="padding: 10px; color: #666;">Nenhum resultado encontrado.</div>';
                return;
            }

            buscaResultadosDiv.style.display = 'block';
            
            // Remove marcadores de usu√°rio temporariamente se a busca retornar resultados
            // e o clustering estiver desativado, para focar nos resultados da busca
            if (!clusteringAtivo) {
                todosMarcadoresUsuario.forEach(m => mapa.removeLayer(m));
            }

            resultados.forEach(resultado => {
                const item = document.createElement('div');
                item.className = 'resultado-item';
                item.innerHTML = `
                    <div class="resultado-nome">${resultado.display_name.split(',')[0]}</div>
                    <div class="resultado-endereco">${resultado.display_name}</div>
                    <div class="resultado-tipo">${resultado.type || 'Ponto de Interesse'}</div>
                `;
                item.onclick = () => {
                    const lat = parseFloat(resultado.lat);
                    const lon = parseFloat(resultado.lon);
                    
                    if (!isNaN(lat) && !isNaN(lon)) {
                        mapa.setView([lat, lon], 16); // Centraliza e d√° zoom no resultado

                        // Adiciona marcador para o resultado da busca
                        const marcadorBusca = L.marker([lat, lon]).addTo(marcadoresBuscaPoi);
                        marcadorBusca.bindPopup(`<strong>${resultado.display_name}</strong>`).openPopup();
                        
                        // Oculta os resultados da busca ap√≥s clicar em um
                        buscaResultadosDiv.style.display = 'none';
                        atualizarEstatisticas();
                    }
                };
                buscaResultadosDiv.appendChild(item);
            });
            atualizarEstatisticas();
        }

        // --- Event Listeners ---

        // Ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', iniciarMapa);

        // Event listener para o bot√£o de busca
        buscaBtn.addEventListener('click', realizarBuscaGeral);

        // Event listener para a tecla Enter no input de busca
        buscaInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                realizarBuscaGeral();
            }
        });
    </script>
</body>
</html>
