
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PINMAP v5.3 - Mapa Interativo com Busca</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f4f7f6;
            color: #333;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            margin: 0;
            font-size: 24px;
        }
        .container {
            display: flex;
            flex-grow: 1;
            padding: 20px;
            gap: 20px;
            box-sizing: border-box;
        }
        .sidebar {
            width: 300px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-shrink: 0;
        }
        .map-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #mapa {
            height: 100%; /* Ocupa o restante do espa√ßo dispon√≠vel */
            min-height: 500px; /* Garante uma altura m√≠nima */
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            background-color: #e0e0e0; /* Cor de fundo enquanto carrega */
        }
        .controles-mapa, .estatisticas-mapa {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .controles-mapa button, .sistema-busca-container button, #estiloMapa {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 8px; /* Espa√ßo entre bot√µes */
        }
        .controles-mapa button:hover, .sistema-busca-container button:hover, #estiloMapa:hover {
            background-color: #2980b9;
        }
        .sistema-busca-container {
            position: relative;
            margin-bottom: 15px;
        }
        .sistema-busca-container input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 14px;
        }
        #busca-resultados {
            position: absolute;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #eee;
            border-top: none;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none; /* Escondido por padr√£o */
        }
        .resultado-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .resultado-item:last-child {
            border-bottom: none;
        }
        .resultado-item:hover {
            background-color: #f0f0f0;
        }
        .resultado-nome {
            font-weight: bold;
            color: #333;
            margin-bottom: 2px;
        }
        .resultado-endereco, .resultado-tipo {
            font-size: 12px;
            color: #666;
        }
        #busca-loading {
            text-align: center;
            padding: 10px;
            font-style: italic;
            color: #555;
            display: none;
        }
        .estatisticas-mapa p {
            margin: 5px 0;
            font-size: 14px;
        }
        .estatisticas-mapa strong {
            color: #2c3e50;
        }

        /* Estilos para os clusters de marcadores */
        .marker-cluster-small div {
            background-color: rgba(181, 226, 140, 0.6);
        }
        .marker-cluster-small span {
            background-color: rgba(181, 226, 140, 0.8);
        }

        .marker-cluster-medium div {
            background-color: rgba(241, 211, 87, 0.6);
        }
        .marker-cluster-medium span {
            background-color: rgba(241, 211, 87, 0.8);
        }

        .marker-cluster-large div {
            background-color: rgba(253, 156, 115, 0.6);
        }
        .marker-cluster-large span {
            background-color: rgba(253, 156, 115, 0.8);
        }

        .marker-cluster div, .marker-cluster span {
            width: 30px;
            height: 30px;
            margin-left: 5px;
            margin-top: 5px;
            border-radius: 15px;
            font-size: 12px;
            line-height: 30px;
            text-align: center;
            font-weight: bold;
            color: white;
            background-color: #2c3e50;
            border: 2px solid #fff;
        }
    </style>
</head>
<body>
    <header>
        <h1>PINMAP v5.3 - Mapa de Usu√°rios</h1>
    </header>
    <div class="container">
        <aside class="sidebar">
            <div class="sistema-busca-container">
                <h3>üîç Buscar Localiza√ß√£o ou Usu√°rio</h3>
                <input type="text" id="busca-geral-input" placeholder="Rua, Cidade, CEP ou Nome do Usu√°rio...">
                <button id="busca-geral-btn">Buscar</button>
                <div id="busca-loading">Carregando...</div>
                <div id="busca-resultados">
                    </div>
            </div>

            <div class="controles-mapa">
                <h3>üõ†Ô∏è Controles do Mapa</h3>
                <button onclick="voltarInicio()">Voltar ao Brasil</button>
                <button onclick="centralizarUsuarios()">Centralizar Usu√°rios</button>
                <button onclick="alternarClustering()">Alternar Agrupamento</button>
                <button onclick="limparBusca()">Limpar Busca</button>
                <button onclick="obterMinhaLocalizacao()">Minha Localiza√ß√£o</button>
                
                <label for="estiloMapa" style="font-size: 13px; font-weight: 500; color: #333; margin-top: 10px; display: block;">Estilo do Mapa:</label>
                <select id="estiloMapa" onchange="alternarEstiloMapa()" 
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px; margin-bottom: 0;">
                    <option value="light">Claro</option>
                    <option value="dark">Escuro</option>
                    <option value="voyager">Detalhado</option>
                </select>
            </div>

            <div class="estatisticas-mapa">
                <h3>üìà Estat√≠sticas</h3>
                <p>Total de Usu√°rios: <strong id="total-usuarios-mapa">0</strong></p>
                <p>Marcadores Vis√≠veis: <strong id="marcadores-visiveis">0</strong></p>
                <p>Zoom Atual: <strong id="zoom-atual">0</strong></p>
                <p>Buscas Realizadas: <strong id="buscas-realizadas-mapa">0</strong></p>
            </div>
        </aside>
        <main class="map-container">
            <div id="mapa"></div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjGwYSPwrKfMwtYVHVLEoNFAj/SsN+"
     crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="dados.js"></script> 
    <script>
        // --- Vari√°veis Globais ---
        let mapa;
        let marcadores; // Grupo de marcadores com clustering
        let todosMarcadoresUsuario = []; // Array para referenciar todos os marcadores de usu√°rio individualmente
        let marcadoresBuscaPoi = L.featureGroup(); // Grupo para marcadores de busca (POIs, CEPs)
        let userLocationMarker = null; // Marcador da localiza√ß√£o do usu√°rio
        let clusteringAtivo = true;
        let contadorBuscas = 0;
        let cacheResultados = new Map(); // Cache para resultados de busca
        let camadasMapa; // Objeto para armazenar as camadas de mapa dispon√≠veis
        let camadaAtual; // Vari√°vel para a camada de mapa ativa
        let estiloAtual = 'light'; // Estilo de mapa padr√£o

        // Coordenadas aproximadas para Campinas, SP (usadas para priorizar buscas)
        const CAMPINAS_VIEWBOX = [-47.2, -23.0, -46.8, -22.7]; // [min_lon, min_lat, max_lon, max_lat]
        const BRASIL_CENTER = [-14.235, -51.925]; // Centro do Brasil
        const BRASIL_ZOOM = 4; // Zoom para o Brasil

        // --- In√≠cio dos √çcones Customizados ---
        const userIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png', // Exemplo: marcador verde para usu√°rios
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        const cepIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-purple.png', // Roxo para CEP
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        const commerceIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', // Vermelho para Com√©rcio/POIs
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        // --- Fim dos √çcones Customizados ---

        // Inicializar mapa
        function inicializarMapa() {
            console.log('üó∫Ô∏è Inicializando PINMAP com Sistema de Busca');
            
            // Criar mapa centrado inicialmente no Brasil
            mapa = L.map('mapa').setView(BRASIL_CENTER, BRASIL_ZOOM);
            
            // Definir as camadas de mapa dispon√≠veis (sem Positron)
            camadasMapa = {
                light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '¬© OpenStreetMap contributors ¬© CartoDB | PINMAP v5.3',
                    noWrap: true,
                    maxZoom: 20
                }),
                dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '¬© OpenStreetMap contributors ¬© CartoDB | PINMAP v5.3',
                    noWrap: true,
                    maxZoom: 20
                }),
                voyager: L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '¬© OpenStreetMap contributors ¬© CartoDB | PINMAP v5.3',
                    noWrap: true,
                    maxZoom: 20
                })
            };

            // Adicionar camada padr√£o (light) ao mapa
            camadaAtual = camadasMapa.light;
            camadaAtual.addTo(mapa);
            
            // Adiciona o grupo de marcadores de POI ao mapa
            marcadoresBuscaPoi.addTo(mapa); 
            
            // Criar grupo de marcadores com clustering
            marcadores = L.markerClusterGroup({
                chunkedLoading: true,
                maxClusterRadius: 50,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let className = 'marker-cluster-small';
                    if (count > 100) className = 'marker-cluster-large';
                    else if (count > 20) className = 'marker-cluster-medium';
                    
                    return new L.DivIcon({
                        html: '<div><span>' + count + '</span></div>',
                        className: 'marker-cluster ' + className,
                        iconSize: new L.Point(40, 40)
                    });
                }
            });
            
            // Carregar usu√°rios
            carregarUsuarios();
            
            // For√ßa o Leaflet a recalcular o tamanho do mapa com um pequeno delay
            setTimeout(() => {
                mapa.invalidateSize(); 
                console.log('DEBUG: mapa.invalidateSize() chamado com setTimeout.');
            }, 100);

            // Configurar eventos do mapa
            configurarEventosMapa();
            
            // Configurar sistema de busca
            configurarSistemaBusca();
            
            // Atualizar estat√≠sticas iniciais
            atualizarEstatisticas();
            
            console.log('‚úÖ PINMAP inicializado com sucesso');
        }
        
        function alternarEstiloMapa() {
            const selectElement = document.getElementById('estiloMapa');
            const novoEstilo = selectElement.value;

            // Remove a camada atual do mapa
            if (camadaAtual) {
                mapa.removeLayer(camadaAtual);
            }

            // Define a nova camada e o estilo atual
            camadaAtual = camadasMapa
